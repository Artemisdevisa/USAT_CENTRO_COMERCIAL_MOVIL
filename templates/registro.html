{% extends "base.html" %}
{% block title %}Registro - Centro Comercial Elías Aguirre{% endblock %}

{% block content %}
<style>
    main { flex: 0 !important; }
    footer { margin-top: 0 !important; }
</style>

<section class="min-h-screen py-12 px-4" style="background: linear-gradient(135deg, #DC143C 0%, #B01030 100%);">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="inline-block bg-red-600 text-white rounded-full p-4 mb-4">
                    <i class="bi bi-person-plus text-4xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">Crear Cuenta</h2>
                <p class="text-gray-600 mt-2">Completa el formulario para registrarte</p>
            </div>

            <form id="formRegistro" class="space-y-4" enctype="multipart/form-data">
                <!-- Datos Personales -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Datos Personales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombres *</label>
                            <input type="text" name="nombres" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Apellidos *</label>
                            <input type="text" name="apellidos" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo Documento *</label>
                            <select name="tipo_doc" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                                <option value="">Seleccionar</option>
                                <option value="1">DNI</option>
                                <option value="2">Pasaporte</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Documento *</label>
                            <input type="text" name="documento" required maxlength="20" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha Nacimiento *</label>
                            <input type="date" name="fecha_nacimiento" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Teléfono *</label>
                            <input type="text" name="telefono" required maxlength="9" pattern="[0-9]{9}" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        
                        <!-- Selectores en cascada -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Departamento *</label>
                            <select id="departamento" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Provincia *</label>
                            <select id="provincia" required disabled class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                                <option value="">Seleccionar departamento primero...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Distrito *</label>
                            <select name="id_dist" id="id_dist" required disabled class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                                <option value="">Seleccionar provincia primero...</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Dirección *</label>
                            <input type="text" name="direccion" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                    </div>
                </div>

                <!-- Datos de Usuario -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Datos de Usuario</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de Usuario *</label>
                            <input type="text" name="nomusuario" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Contraseña *</label>
                            <input type="password" name="password" required minlength="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Confirmar Contraseña *</label>
                            <input type="password" name="password_confirm" required minlength="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Foto de Perfil (Opcional)</label>
                            <input type="file" name="img_logo" accept="image/*" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-red-600">
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button type="button" onclick="window.location.href='/'" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold">
                        <i class="bi bi-person-plus"></i> Registrarse
                    </button>
                </div>
            </form>

            <div class="text-center mt-6">
                <p class="text-gray-600">
                    ¿Ya tienes cuenta? 
                    <a href="/login" class="text-red-600 font-bold hover:text-red-700">Inicia Sesión aquí</a>
                </p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const API_URL = window.CONFIG?.API_URL || 'http://127.0.0.1:3007';

// Cargar departamentos al iniciar
(async function cargarDepartamentos() {
    try {
        const res = await fetch(`${API_URL}/departamentos/listar`);
        const data = await res.json();
        
        if (data.status) {
            const select = document.getElementById('departamento');
            data.data.forEach(dep => {
                const option = document.createElement('option');
                option.value = dep.id_dep;
                option.textContent = dep.nombre;
                select.appendChild(option);
            });
        }
    } catch (e) {
        console.error('Error al cargar departamentos:', e);
    }
})();

// Cargar provincias al seleccionar departamento
document.getElementById('departamento').addEventListener('change', async (e) => {
    const idDep = e.target.value;
    const selectProv = document.getElementById('provincia');
    const selectDist = document.getElementById('id_dist');
    
    selectProv.innerHTML = '<option value="">Cargando...</option>';
    selectProv.disabled = true;
    selectDist.innerHTML = '<option value="">Seleccionar provincia primero...</option>';
    selectDist.disabled = true;
    
    if (!idDep) return;
    
    try {
        const res = await fetch(`${API_URL}/provincias/listar/${idDep}`);
        const data = await res.json();
        
        if (data.status) {
            selectProv.innerHTML = '<option value="">Seleccionar...</option>';
            data.data.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.id_prov;
                option.textContent = prov.nombre;
                selectProv.appendChild(option);
            });
            selectProv.disabled = false;
        }
    } catch (e) {
        console.error('Error al cargar provincias:', e);
        selectProv.innerHTML = '<option value="">Error al cargar</option>';
    }
});

// Cargar distritos al seleccionar provincia
document.getElementById('provincia').addEventListener('change', async (e) => {
    const idProv = e.target.value;
    const selectDist = document.getElementById('id_dist');
    
    selectDist.innerHTML = '<option value="">Cargando...</option>';
    selectDist.disabled = true;
    
    if (!idProv) return;
    
    try {
        const res = await fetch(`${API_URL}/distritos/listar/${idProv}`);
        const data = await res.json();
        
        if (data.status) {
            selectDist.innerHTML = '<option value="">Seleccionar...</option>';
            data.data.forEach(dist => {
                const option = document.createElement('option');
                option.value = dist.id_dist;
                option.textContent = dist.nombre;
                selectDist.appendChild(option);
            });
            selectDist.disabled = false;
        }
    } catch (e) {
        console.error('Error al cargar distritos:', e);
        selectDist.innerHTML = '<option value="">Error al cargar</option>';
    }
});

// Enviar formulario
document.getElementById('formRegistro').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // Validar contraseñas
    if (formData.get('password') !== formData.get('password_confirm')) {
        alert('❌ Las contraseñas no coinciden');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/api/usuario/registrar-completo`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status) {
            alert('✅ Registro exitoso. Ahora puedes iniciar sesión');
            window.location.href = '/login';
        } else {
            alert(`❌ ${data.message}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al registrar');
    }
});
</script>
{% endblock %}