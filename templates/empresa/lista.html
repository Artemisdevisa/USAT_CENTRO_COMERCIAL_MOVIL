<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empresas - Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="/static/js/config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; overflow-x: hidden; }
        
        .layout { display: flex; min-height: 100vh; }
        
        #sidebar { width: 250px; background: #dc2626; color: white; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-title { font-size: 1.375rem; font-weight: 700; display: flex; align-items: center; gap: 0.625rem; }
        .sidebar-user { font-size: 0.875rem; color: rgba(255,255,255,0.9); margin-top: 0.625rem; }
        .sidebar-badge { display: inline-block; background: rgba(0,0,0,0.3); padding: 0.25rem 0.625rem; border-radius: 0.375rem; font-size: 0.75rem; margin-top: 0.375rem; }
        .sidebar-nav { padding: 1.25rem; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; border-radius: 0.5rem; color: white; text-decoration: none; transition: all 0.2s; margin-bottom: 0.375rem; font-size: 0.9375rem; }
        .sidebar-link:hover { background: rgba(255,255,255,0.1); color: white; transform: translateX(4px); }
        .sidebar-link.active { background: rgba(255,255,255,0.2); font-weight: 600; }
        .sidebar-link i { font-size: 1.125rem; }
        
        #content { flex: 1; }
        
        .page-header { background: white; padding: 1.5rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.625rem; }
        .page-title i { color: #dc2626; }
        
        .main-content { padding: 2rem; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 2rem; }
        .card-header { padding: 1.25rem 1.75rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; }
        th { padding: 1rem 1.5rem; text-align: left; font-weight: 600; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; }
        td { padding: 1.125rem 1.5rem; border-top: 1px solid #f3f4f6; font-size: 0.9375rem; }
        tbody tr { transition: background 0.15s; }
        tbody tr:hover { background: #fef2f2; }
        
        .btn-icon { padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-success { background: #10b981; color: white; margin-right: 0.5rem; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-delete { background: #dc2626; color: white; margin-right: 0.5rem; }
        .btn-delete:hover { background: #b91c1c; transform: translateY(-2px); }
        .btn-info { background: #3b82f6; color: white; }
        .btn-info:hover { background: #2563eb; transform: translateY(-2px); }
        
        .badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 0.875rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-green { background: #d1fae5; color: #065f46; }
        
        .tab-buttons { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .tab-btn { padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .tab-btn.active { background: #dc2626; color: white; border-color: #dc2626; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="layout">
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title"><i class="bi bi-shop"></i>Dashboard</div>
                <div class="sidebar-user">Centro Comercial Elías Aguirre</div>
                <span class="sidebar-badge">Administrador</span>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="sidebar-link"><i class="bi bi-house-door"></i>Inicio</a>
                <a href="/dashboard/empresas" class="sidebar-link active"><i class="bi bi-building"></i>Empresas</a>
                <a href="/dashboard/roles" class="sidebar-link"><i class="bi bi-person-badge"></i>Roles</a>
                <a href="/dashboard/categorias" class="sidebar-link"><i class="bi bi-tags"></i>Categorías</a>
                <a href="/" class="sidebar-link" style="margin-top:2.5rem"><i class="bi bi-house"></i>Volver al Inicio</a>
            </nav>
        </aside>
        
        <main id="content">
            <header class="page-header">
                <h1 class="page-title"><i class="bi bi-building"></i>Gestión de Empresas</h1>
            </header>
            
            <div class="main-content">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="cambiarTab('pendientes')">
                        <i class="bi bi-clock-history"></i> Pendientes de Aprobación
                        <span class="badge badge-warning" id="count-pendientes">0</span>
                    </button>
                    <button class="tab-btn" onclick="cambiarTab('aprobadas')">
                        <i class="bi bi-check-circle"></i> Empresas Aprobadas
                        <span class="badge badge-green" id="count-aprobadas">0</span>
                    </button>
                </div>

                <div id="tab-pendientes" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Solicitudes Pendientes</h5>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>RUC</th>
                                        <th>RAZÓN SOCIAL</th>
                                        <th>NOMBRE COMERCIAL</th>
                                        <th>USUARIO</th>
                                        <th style="text-align:center">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-pendientes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-aprobadas" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Empresas Aprobadas</h5>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>RUC</th>
                                        <th>RAZÓN SOCIAL</th>
                                        <th>NOMBRE COMERCIAL</th>
                                        <th>USUARIO</th>
                                        <th style="text-align:center">ESTADO</th>
                                        <th style="text-align:center">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-aprobadas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Detalles de la Empresa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = window.CONFIG?.API_URL || 'http://127.0.0.1:3007';
        let empresasPendientes = [];
        let empresasAprobadas = [];

        async function cargar() {
            try {
                const res = await fetch(`${API}/empresas/listar-admin`);
                const data = await res.json();
                
                if (data.status) {
                    empresasPendientes = data.data.filter(e => !e.estado);
                    empresasAprobadas = data.data.filter(e => e.estado);
                    
                    document.getElementById('count-pendientes').textContent = empresasPendientes.length;
                    document.getElementById('count-aprobadas').textContent = empresasAprobadas.length;
                    
                    renderPendientes();
                    renderAprobadas();
                }
            } catch (e) {
                console.error('Error al cargar empresas:', e);
            }
        }

        function renderPendientes() {
            const tbody = document.getElementById('tabla-pendientes');
            
            if (!empresasPendientes.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:3rem;color:#9ca3af">No hay solicitudes pendientes</td></tr>';
                return;
            }
            
            tbody.innerHTML = empresasPendientes.map(e => `
                <tr>
                    <td>${e.ruc}</td>
                    <td class="fw-bold">${e.razon_social}</td>
                    <td>${e.nombre_comercial}</td>
                    <td>${e.usuario || 'N/A'}</td>
                    <td style="text-align:center">
                        <button class="btn-icon btn-success" onclick="aprobar(${e.id_solicitud})" title="Aprobar">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="rechazar(${e.id_solicitud})" title="Rechazar">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn-icon btn-info" onclick="verDetalle(${e.id_solicitud})" title="Ver detalles">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderAprobadas() {
            const tbody = document.getElementById('tabla-aprobadas');
            
            if (!empresasAprobadas.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:3rem;color:#9ca3af">No hay empresas aprobadas</td></tr>';
                return;
            }
            
            tbody.innerHTML = empresasAprobadas.map(e => `
                <tr>
                    <td>${e.ruc}</td>
                    <td class="fw-bold">${e.razon_social}</td>
                    <td>${e.nombre_comercial}</td>
                    <td>${e.usuario || 'N/A'}</td>
                    <td style="text-align:center">
                        <span class="badge badge-green"><i class="bi bi-check-circle"></i>Activa</span>
                    </td>
                    <td style="text-align:center">
                        <button class="btn-icon btn-info" onclick="verDetalle(${e.id_solicitud})">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function cambiarTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        async function aprobar(id) {
            if (!confirm('¿Aprobar esta empresa?')) return;
            
            try {
                const res = await fetch(`${API}/empresas/aprobar/${id}`, { method: 'PATCH' });
                const data = await res.json();
                
                if (data.status) {
                    alert('✅ Empresa aprobada');
                    await cargar();
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (e) {
                alert('Error al aprobar');
            }
        }

        async function rechazar(id) {
            if (!confirm('¿Rechazar esta solicitud?')) return;
            
            try {
                const res = await fetch(`${API}/empresas/rechazar/${id}`, { method: 'DELETE' });
                const data = await res.json();
                
                if (data.status) {
                    alert('✅ Solicitud rechazada');
                    await cargar();
                } else {
                    alert('❌ ' + data.message);
                }
            } catch (e) {
                alert('Error al rechazar');
            }
        }

        async function verDetalle(id) {
            try {
                const res = await fetch(`${API}/empresas/obtener/${id}`);
                const data = await res.json();
                
                if (data.status) {
                    const e = data.data;
                    document.getElementById('detalleContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6"><strong>RUC:</strong> ${e.ruc}</div>
                            <div class="col-md-6"><strong>Razón Social:</strong> ${e.razon_social}</div>
                            <div class="col-md-6 mt-3"><strong>Nombre Comercial:</strong> ${e.nombre_comercial}</div>
                            <div class="col-md-6 mt-3"><strong>Teléfono:</strong> ${e.telefono}</div>
                            <div class="col-12 mt-3"><strong>Descripción:</strong><br>${e.descripcion}</div>
                            <div class="col-12 mt-3"><strong>Dirección:</strong><br>${e.direccion}</div>
                        </div>
                    `;
                    new bootstrap.Modal(document.getElementById('modalDetalle')).show();
                }
            } catch (e) {
                alert('Error al cargar detalles');
            }
        }

        cargar();
    </script>
</body>
</html>